# BMS系统
## 系统规格
- 电池类型：锂电池
- 电池电压：2s, 7.4V
- 电池容量：300mAh
- 电池充电电流：2~4A
- 电池放电电流：6A (典型) 10A (峰值)
## 系统架构
```mermaid
graph TD
    subgraph 制导飞镖智能飞行电池
        A[STM32L0F6P6]
        B[BQ40Z50]
        C[2S锂电池]
        D[电池NTC]
        E[FET NTC]
        C --> B
        D --> B
        E --> B
        %% B双向箭头A，箭头上写I2C
        B <-->|I2C| A

    end
```
## 系统状态机
> 因为低功耗需要，系统使用裸机开发，不使用RTOS

BMS状态机
```mermaid
stateDiagram-v2
    [*] --> 初始化
    state fork_state_更新状态 <<fork>>
    state join_state_更新状态 <<join>>
    初始化 --> fork_state_更新状态
    join_state_更新状态 --> 休眠: PRES为高电平且系统电源未开启/系统电源开启，但0负载超过10s
    fork_state_更新状态 --> 按键第一次按下: 按键按下
    fork_state_更新状态 --> join_state_更新状态: 按键未按下
    join_state_更新状态 --> fork_state_更新状态: PRES为低电平
    按键第一次按下 --> 按键已经短按一次: 按键释放
    按键已经短按一次 --> 按键长按中（LED灯效）: 按键在1s内再次被按下
    按键已经短按一次 --> join_state_更新状态: 按键在1s内未被再次按下
    按键长按中（LED灯效） --> join_state_更新状态: 按键释放/计数到达1s

    休眠 --> fork_state_更新状态: RTC唤醒/按键唤醒

    note right of 初始化: 初始化I2C，RTC，尝试打开BQ40Z50的PCHG、CHG、DSG FET，防止亏电充不进电FET，防止亏电充不进电
    note right of 休眠: 低功耗模式，如果PRES为低，说明电池未接入任何系统，大部分时间系统处于此状态
    note right of 按键第一次按下: 此时开灯效进入短暂显示状态
    note right of 按键已经短按一次: 此时开灯效进入短按长按灯效状态，灯效状态根据电源为开为关确认
    note right of 按键长按中（LED灯效）: 此时开灯效进入常亮显示状态，关灯效进入关闭状态
```

系统FET电源状态机
```mermaid
stateDiagram-v2
    [*] --> 系统电源开启
    系统电源开启 --> 系统电源关闭: 没有进入充电状态/0负载超过10s/电量低/过充保护激活
    系统电源关闭 --> 系统电源开启: PACK电压>=8V/按键短按一次，再长按一次
```
> 电源是否开启取决于BQ40Z50内部的CHG、DSG FET是否打开，必须实时更新。

系统灯效状态机
```mermaid
stateDiagram-v2
    短暂显示状态
    短按长按灯效状态
    常亮显示状态
    错误显示状态
    关闭状态
    [*] --> 关闭状态
    关闭状态 --> 短暂显示状态: 按键短按一次
    短暂显示状态 --> 短按长按灯效状态: 按键短按一次后在1s内再次被按下
    短按长按灯效状态 --> 常亮显示状态: 按键保持长按1s
    关闭状态 --> 常亮显示状态: 进入充电状态
    关闭状态 --> 错误显示状态: 过温保护激活
    错误显示状态 --> 关闭状态: 过温保护解除
    常亮显示状态 --> 关闭状态: 电源关闭
```
